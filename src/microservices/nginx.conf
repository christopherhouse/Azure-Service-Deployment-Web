events {
    worker_connections 1024;
}

http {
    upstream frontend {
        server frontend:80;
    }

    upstream identity-api {
        server identity-api:8080;
    }

    upstream account-api {
        server account-api:8080;
    }

    upstream template-library-api {
        server template-library-api:8080;
    }

    upstream deployment-api {
        server deployment-api:8080;
    }

    upstream billing-api {
        server billing-api:8080;
    }

    server {
        listen 80;
        
        # Frontend SPA
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # API Routes
        location /api/identity/ {
            rewrite ^/api/identity/(.*) /$1 break;
            proxy_pass http://identity-api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/account/ {
            rewrite ^/api/account/(.*) /$1 break;
            proxy_pass http://account-api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/templates/ {
            rewrite ^/api/templates/(.*) /$1 break;
            proxy_pass http://template-library-api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/deployments/ {
            rewrite ^/api/deployments/(.*) /$1 break;
            proxy_pass http://deployment-api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/billing/ {
            rewrite ^/api/billing/(.*) /$1 break;
            proxy_pass http://billing-api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health checks
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}